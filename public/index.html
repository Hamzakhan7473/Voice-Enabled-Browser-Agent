<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Enabled Browser Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .control-panel {
            text-align: center;
        }

        .status-panel {
            min-height: 200px;
        }

        .mic-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
            box-shadow: 0 8px 25px rgba(238, 90, 36, 0.4);
        }

        .mic-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(238, 90, 36, 0.6);
        }

        .mic-button.listening {
            background: linear-gradient(45deg, #00b894, #00a085);
            animation: pulse 2s infinite;
        }

        .mic-button.processing {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.online { background: #00b894; }
        .status-indicator.offline { background: #e17055; }
        .status-indicator.listening { background: #0984e3; animation: pulse 1s infinite; }

        .status-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #0984e3;
        }

        .transcript-box {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-y: auto;
        }

        .intent-display {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .error-display {
            background: #ffe8e8;
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .confirmation-dialog {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .confirmation-buttons {
            margin-top: 15px;
        }

        .confirmation-buttons button {
            margin: 0 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .confirm-btn {
            background: #28a745;
            color: white;
        }

        .cancel-btn {
            background: #dc3545;
            color: white;
        }

        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .log-info { background: rgba(59, 130, 246, 0.1); }
        .log-success { background: rgba(34, 197, 94, 0.1); }
        .log-error { background: rgba(239, 68, 68, 0.1); }
        .log-warning { background: rgba(245, 158, 11, 0.1); }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: #0984e3;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            background: #0770c4;
            transform: translateY(-2px);
        }

        .action-btn.secondary {
            background: #6c757d;
        }

        .action-btn.secondary:hover {
            background: #5a6268;
        }

        .screenshot-container {
            margin: 15px 0;
            text-align: center;
        }

        .screenshot-container img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0984e3, #00b894);
            transition: width 0.3s ease;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .mic-button {
                width: 100px;
                height: 100px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Voice Enabled Browser Agent</h1>
            <p>Control your browser with natural speech commands</p>
        </div>

        <div class="main-content">
            <div class="panel control-panel">
                <h2>üéôÔ∏è Voice Control</h2>
                <button id="micButton" class="mic-button" title="Click to start/stop listening">
                    üé§
                </button>
                <p id="micStatus">Click the microphone to start listening</p>
                
                <div class="action-buttons">
                    <button class="action-btn" onclick="takeScreenshot()">üì∏ Screenshot</button>
                    <button class="action-btn" onclick="extractData()">üìä Extract Data</button>
                    <button class="action-btn" onclick="refreshPage()">üîÑ Refresh</button>
                    <button class="action-btn secondary" onclick="exportSession()">üíæ Export</button>
                    <button class="action-btn secondary" onclick="clearLogs()">üóëÔ∏è Clear</button>
                </div>
            </div>

            <div class="panel status-panel">
                <h2>üìä Status & Feedback</h2>
                <div id="statusContainer">
                    <div class="status-item">
                        <span class="status-indicator offline" id="connectionStatus"></span>
                        <strong>Connection:</strong> <span id="connectionText">Disconnected</span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator offline" id="browserStatus"></span>
                        <strong>Browser:</strong> <span id="browserText">Not Connected</span>
                    </div>
                    <div class="status-item">
                        <strong>Current Page:</strong> <span id="currentPage">None</span>
                    </div>
                    <div class="status-item">
                        <strong>Session ID:</strong> <span id="sessionId">None</span>
                    </div>
                </div>

                <div id="transcriptContainer" class="transcript-box" style="display: none;">
                    <h3>üìù Live Transcript</h3>
                    <div id="transcriptText"></div>
                </div>

                <div id="intentContainer" class="intent-display" style="display: none;">
                    <h3>üéØ Parsed Intent</h3>
                    <div id="intentText"></div>
                </div>

                <div id="confirmationContainer" class="confirmation-dialog" style="display: none;">
                    <h3>‚ö†Ô∏è Confirmation Required</h3>
                    <div id="confirmationText"></div>
                    <div class="confirmation-buttons">
                        <button class="confirm-btn" onclick="confirmAction(true)">‚úÖ Confirm</button>
                        <button class="cancel-btn" onclick="confirmAction(false)">‚ùå Cancel</button>
                    </div>
                </div>

                <div id="errorContainer" class="error-display" style="display: none;">
                    <h3>‚ùå Error</h3>
                    <div id="errorText"></div>
                </div>

                <div id="screenshotContainer" class="screenshot-container" style="display: none;">
                    <h3>üì∏ Screenshot</h3>
                    <img id="screenshotImage" src="" alt="Screenshot">
                </div>

                <div id="dataContainer" style="display: none;">
                    <h3>üìä Extracted Data</h3>
                    <div id="dataContent"></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üìã Activity Log</h2>
            <div id="logContainer" class="log-container">
                <div class="log-entry log-info">System initialized. Ready to receive voice commands.</div>
            </div>
        </div>

        <div class="footer">
            <p>Voice Enabled Browser Agent - Powered by Deepgram, Browserbase, and OpenAI</p>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Socket connection
        const socket = io();
        let isListening = false;
        let currentConfirmation = null;

        // DOM elements
        const micButton = document.getElementById('micButton');
        const micStatus = document.getElementById('micStatus');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const browserStatus = document.getElementById('browserStatus');
        const browserText = document.getElementById('browserText');
        const currentPage = document.getElementById('currentPage');
        const sessionId = document.getElementById('sessionId');
        const transcriptContainer = document.getElementById('transcriptContainer');
        const transcriptText = document.getElementById('transcriptText');
        const intentContainer = document.getElementById('intentContainer');
        const intentText = document.getElementById('intentText');
        const confirmationContainer = document.getElementById('confirmationContainer');
        const confirmationText = document.getElementById('confirmationText');
        const errorContainer = document.getElementById('errorContainer');
        const errorText = document.getElementById('errorText');
        const screenshotContainer = document.getElementById('screenshotContainer');
        const screenshotImage = document.getElementById('screenshotImage');
        const dataContainer = document.getElementById('dataContainer');
        const dataContent = document.getElementById('dataContent');
        const logContainer = document.getElementById('logContainer');

        // Socket event handlers
        socket.on('connect', () => {
            updateConnectionStatus(true);
            addLog('Connected to server', 'success');
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
            addLog('Disconnected from server', 'error');
        });

        socket.on('listening-started', (data) => {
            isListening = true;
            updateMicButton('listening');
            micStatus.textContent = 'Listening for voice commands...';
            addLog('Voice listening started', 'info');
        });

        socket.on('listening-stopped', (data) => {
            isListening = false;
            updateMicButton('idle');
            micStatus.textContent = 'Click the microphone to start listening';
            addLog('Voice listening stopped', 'info');
        });

        socket.on('transcript', (data) => {
            showTranscript(data.transcript, data.confidence, data.isFinal);
            if (data.isFinal) {
                addLog(`Transcript: "${data.transcript}" (confidence: ${Math.round(data.confidence * 100)}%)`, 'info');
            }
        });

        socket.on('intent-parsed', (data) => {
            showIntent(data);
            addLog(`Intent parsed: ${data.intent}`, 'success');
        });

        socket.on('execution-started', (data) => {
            addLog(`Executing: ${data.intent}`, 'info');
        });

        socket.on('execution-completed', (data) => {
            addLog(`Execution completed: ${data.intent}`, 'success');
        });

        socket.on('execution-error', (data) => {
            addLog(`Execution failed: ${data.error}`, 'error');
        });

        socket.on('confirmation-required', (data) => {
            showConfirmation(data);
        });

        socket.on('feedback', (data) => {
            handleFeedback(data);
        });

        socket.on('error', (data) => {
            showError(data.message);
            addLog(`Error: ${data.message}`, 'error');
        });

        // Mic button click handler
        micButton.addEventListener('click', () => {
            if (isListening) {
                socket.emit('stop-listening');
            } else {
                socket.emit('start-listening');
            }
        });

        // Update connection status
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.className = 'status-indicator online';
                connectionText.textContent = 'Connected';
            } else {
                connectionStatus.className = 'status-indicator offline';
                connectionText.textContent = 'Disconnected';
            }
        }

        // Update mic button state
        function updateMicButton(state) {
            micButton.className = `mic-button ${state}`;
            if (state === 'listening') {
                micButton.textContent = 'üî¥';
            } else if (state === 'processing') {
                micButton.textContent = '‚è≥';
            } else {
                micButton.textContent = 'üé§';
            }
        }

        // Show transcript
        function showTranscript(transcript, confidence, isFinal) {
            transcriptContainer.style.display = 'block';
            transcriptText.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Text:</strong> "${transcript}"
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Confidence:</strong> ${Math.round(confidence * 100)}%
                </div>
                <div>
                    <strong>Status:</strong> ${isFinal ? 'Final' : 'Interim'}
                </div>
            `;
        }

        // Show intent
        function showIntent(data) {
            intentContainer.style.display = 'block';
            intentText.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Intent:</strong> ${data.intent}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Parameters:</strong> <pre style="background: white; padding: 10px; border-radius: 5px; margin: 5px 0;">${JSON.stringify(data.parameters, null, 2)}</pre>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Confidence:</strong> ${Math.round(data.confidence * 100)}%
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Risk Level:</strong> ${data.riskLevel}
                </div>
                <div>
                    <strong>Requires Confirmation:</strong> ${data.requiresConfirmation ? 'Yes' : 'No'}
                </div>
            `;
        }

        // Show confirmation dialog
        function showConfirmation(data) {
            currentConfirmation = data;
            confirmationContainer.style.display = 'block';
            confirmationText.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Action:</strong> ${data.intent}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Original Text:</strong> "${data.originalText}"
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Risk Level:</strong> ${data.riskLevel}
                </div>
                <div>
                    <strong>Parameters:</strong> <pre style="background: white; padding: 10px; border-radius: 5px; margin: 5px 0;">${JSON.stringify(data.parameters, null, 2)}</pre>
                </div>
            `;
        }

        // Confirm action
        function confirmAction(confirmed) {
            if (currentConfirmation) {
                socket.emit('confirmation-response', { confirmed });
                confirmationContainer.style.display = 'none';
                currentConfirmation = null;
                addLog(`Action ${confirmed ? 'confirmed' : 'cancelled'}`, confirmed ? 'success' : 'warning');
            }
        }

        // Show error
        function showError(message) {
            errorContainer.style.display = 'block';
            errorText.textContent = message;
            setTimeout(() => {
                errorContainer.style.display = 'none';
            }, 5000);
        }

        // Handle feedback
        function handleFeedback(data) {
            switch (data.type) {
                case 'screenshot':
                    showScreenshot(data.content);
                    break;
                case 'data-extracted':
                    showExtractedData(data.content);
                    break;
                case 'status':
                    addLog(`Status: ${data.content.status} - ${data.content.details || ''}`, 'info');
                    break;
                case 'progress':
                    addLog(`Progress: ${data.content.progress}% - ${data.content.description}`, 'info');
                    break;
                case 'summary':
                    addLog(`Session Summary: ${JSON.stringify(data.content)}`, 'info');
                    break;
            }
        }

        // Show screenshot
        function showScreenshot(data) {
            screenshotContainer.style.display = 'block';
            screenshotImage.src = `/screenshots/${data.filename}`;
            addLog(`Screenshot taken: ${data.filename}`, 'success');
        }

        // Show extracted data
        function showExtractedData(data) {
            dataContainer.style.display = 'block';
            if (Array.isArray(data.data)) {
                const table = document.createElement('table');
                table.className = 'data-table';
                
                if (data.data.length > 0) {
                    const headers = Object.keys(data.data[0]);
                    const headerRow = table.insertRow();
                    headers.forEach(header => {
                        const th = document.createElement('th');
                        th.textContent = header;
                        headerRow.appendChild(th);
                    });
                    
                    data.data.forEach(row => {
                        const tr = table.insertRow();
                        headers.forEach(header => {
                            const td = document.createElement('td');
                            td.textContent = row[header] || '';
                            tr.appendChild(td);
                        });
                    });
                }
                
                dataContent.innerHTML = '';
                dataContent.appendChild(table);
            } else {
                dataContent.innerHTML = `<pre>${JSON.stringify(data.data, null, 2)}</pre>`;
            }
            
            addLog(`Data extracted: ${data.count} items`, 'success');
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Action functions
        function takeScreenshot() {
            socket.emit('execute-command', {
                intent: 'screenshot',
                parameters: { fullPage: true }
            });
        }

        function extractData() {
            socket.emit('execute-command', {
                intent: 'extract',
                parameters: { dataType: 'text' }
            });
        }

        function refreshPage() {
            socket.emit('execute-command', {
                intent: 'navigate',
                parameters: { action: 'refresh' }
            });
        }

        function exportSession() {
            // This would trigger a download of the session data
            addLog('Export functionality would be implemented here', 'info');
        }

        function clearLogs() {
            logContainer.innerHTML = '';
            addLog('Logs cleared', 'info');
        }

        // Initialize
        addLog('Web interface loaded', 'success');
    </script>
</body>
</html>
